{% extends 'template_citiesoft.html' %}
{% load static %}

{% block title %}AtribuiÃ§Ã£o de Tickets - Citiesoft{% endblock %}

{% block extra_css %}
<link href="{% static 'menu/css/atribuicao_tickets.css' %}" rel="stylesheet">
<style>
    /* Ajuste para o novo botÃ£o de Chat */
    .btn-chat {
        background-color: #28a745 !important;
        color: white !important;
        border: none !important;
    }
    .btn-chat:hover {
        background-color: #218838 !important;
        transform: translateY(-2px);
    }
    .ticket-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    /* Faz o botÃ£o de histÃ³rico ou atribuir ocupar a linha toda se necessÃ¡rio */
    .btn-full {
        grid-column: span 2;
    }
</style>
{% endblock %}

{% block page_header %}
<h1>
    <i class="fas fa-users-cog"></i> AtribuiÃ§Ã£o de Tickets
</h1>
<p>
    Gerencie e distribua tickets entre a equipe de suporte â€¢ 
    <span id="currentDate"></span> â€¢ 
    <span id="userInfoHeader"></span>
</p>
{% endblock %}

{% block content %}
<form id="csrf-form">{% csrf_token %}</form>

<div class="stats-grid">
    <div class="stat-card stat-total">
        <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
        <div class="stat-content">
            <div class="stat-value" id="totalTickets">0</div>
            <div class="stat-label">Total de Tickets</div>
        </div>
    </div>
    <div class="stat-card stat-open">
        <div class="stat-icon"><i class="fas fa-folder-open"></i></div>
        <div class="stat-content">
            <div class="stat-value" id="abertosCount">0</div>
            <div class="stat-label">Abertos</div>
        </div>
    </div>
    <div class="stat-card stat-progress">
        <div class="stat-icon"><i class="fas fa-tasks"></i></div>
        <div class="stat-content">
            <div class="stat-value" id="progrisoCount">0</div>
            <div class="stat-label">Em Andamento</div>
        </div>
    </div>
    <div class="stat-card stat-waiting">
        <div class="stat-icon"><i class="fas fa-clock"></i></div>
        <div class="stat-content">
            <div class="stat-value" id="aguardandoCount">0</div>
            <div class="stat-label">Aguardando</div>
        </div>
    </div>
    <div class="stat-card stat-closed">
        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
        <div class="stat-content">
            <div class="stat-value" id="fechadosCount">0</div>
            <div class="stat-label">ConcluÃ­dos</div>
        </div>
    </div>
</div>

<div class="filters-section">
    <div class="filters-header">
        <h2><i class="fas fa-filter"></i> Filtros e Busca</h2>
        <div class="filters-actions">
            <button class="btn-action btn-refresh" id="btnRefresh" onclick="TicketManager.loadTickets()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <button class="btn-action btn-clear" id="btnClearFilters">
                <i class="fas fa-eraser"></i> Limpar
            </button>
        </div>
    </div>
    <div class="filters-grid">
        <div class="filter-group">
            <label class="filter-label"><i class="fas fa-info-circle"></i> Status</label>
            <select class="filter-select" id="filterStatus" onchange="FilterManager.updateFilters()">
                <option value="">Todos os Status</option>
                <option value="aberto">ðŸ”´ Aberto</option>
                <option value="em_progresso">ðŸŸ¡ Em Andamento</option>
                <option value="aguardando">ðŸŸ  Aguardando</option>
                <option value="fechado">ðŸŸ¢ ConcluÃ­do</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label"><i class="fas fa-exclamation-triangle"></i> Prioridade</label>
            <select class="filter-select" id="filterPriority" onchange="FilterManager.updateFilters()">
                <option value="">Todas as Prioridades</option>
                <option value="alto">ðŸ”´ Alta</option>
                <option value="medio">ðŸŸ¡ MÃ©dia</option>
                <option value="baixo">ðŸŸ¢ Baixa</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label"><i class="fas fa-user-tie"></i> TÃ©cnico</label>
            <select class="filter-select" id="filterTechnician" onchange="FilterManager.updateFilters()">
                <option value="">Todos os TÃ©cnicos</option>
                <option value="nao_atribuido">âšª NÃ£o AtribuÃ­do</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label"><i class="fas fa-search"></i> Pesquisar</label>
            <input type="text" class="filter-input" id="searchInput" placeholder="ID, tÃ­tulo, cliente..." oninput="FilterManager.updateFilters()">
        </div>
    </div>
</div>

<div id="loadingState" class="loading-state" style="display: none;">
    <div class="loading-spinner"></div>
    <p>Carregando tickets...</p>
</div>

<div class="tickets-grid" id="ticketsGrid"></div>

<div class="modal fade" id="attributionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attributionModalLabel">
                    <i class="fas fa-user-check"></i> Atribuir Ticket
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="attributionForm" novalidate onsubmit="TicketManager.confirmAttribution(event)">
                <div class="modal-body">
                    <div class="ticket-info-box">
                        <div class="info-row">
                            <div class="info-item">
                                <label><i class="fas fa-hashtag"></i> ID do Ticket</label>
                                <input type="text" class="form-control-modal" id="modalTicketId" readonly>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-heading"></i> TÃ­tulo</label>
                                <input type="text" class="form-control-modal" id="modalTicketTitle" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label-modal required">
                            <i class="fas fa-user-tie"></i> TÃ©cnico
                        </label>
                        <select class="form-select-modal" id="modalTechnician" required>
                            <option value="">Selecione...</option>
                        </select>
                        <div class="invalid-feedback">Selecione um tÃ©cnico</div>
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label-modal">
                            <i class="fas fa-layer-group"></i> Escalonamento
                        </label>
                        <select class="form-select-modal" id="modalEscalation">
                            <option value="n1">NÃ­vel 1 - Suporte BÃ¡sico</option>
                            <option value="n2">NÃ­vel 2 - Suporte AvanÃ§ado</option>
                            <option value="n3">NÃ­vel 3 - Especialista</option>
                        </select>
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label-modal">
                            <i class="fas fa-comment-alt"></i> ObservaÃ§Ãµes
                        </label>
                        <textarea class="form-textarea-modal" id="modalObservations" rows="4" maxlength="500"></textarea>
                        <small class="char-counter"><span id="charCount">0</span> / 500</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modal btn-cancel" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn-modal btn-confirm">
                        <i class="fas fa-check"></i> Confirmar AtribuiÃ§Ã£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history"></i> HistÃ³rico <span id="historyTicketId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="history-timeline" id="historyContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal btn-cancel" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. ConfiguraÃ§Ã£o do UsuÃ¡rio vinda do Django
    window.CURRENT_USER = {
        id: '{{ user.username }}',
        name: '{{ user.get_full_name|default:user.username }}',
        role: {% if user.is_superuser or user.is_staff %}'admin'{% else %}'technician'{% endif %}
    };

    // 2. Data Atual
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
    });

    // 3. Contador de Caracteres do Modal
    const obsTextarea = document.getElementById('modalObservations');
    if (obsTextarea) {
        obsTextarea.addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length;
        });
    }
</script>

<script src="{% static 'menu/js/atribuicao_tickets.js' %}"></script>

<script>
    // InicializaÃ§Ã£o da UI apÃ³s carregar o script
    document.addEventListener('DOMContentLoaded', () => {
        UI.updateUserInfo();
        UI.loadTechnicians();
        TicketManager.loadTickets();
    });
</script>
{% endblock %}